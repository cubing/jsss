import{b as t,S as e,r as i}from"./index-03ee41f0.js";import{Quaternion as r,Vector3 as n}from"three";import{K as a,P as o}from"./index-bceade28.js";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function s(t,e,i,r){return new(i||(i=Promise))((function(n,a){function o(t){try{c(r.next(t))}catch(t){a(t)}}function s(t){try{c(r.throw(t))}catch(t){a(t)}}function c(t){t.done?n(t.value):new i((function(e){e(t.value)})).then(o,s)}c((r=r.apply(t,e||[])).next())}))}function c(t){switch(Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))){case t.x:return"x";case-t.x:return"-x";case t.y:return"y";case-t.y:return"-y";case t.z:return"z";case-t.z:return"-z";default:throw new Error("Uh-oh.")}}const u=Math.sqrt(.5),l={"y z":new r(0,0,0,1),"-z y":new r(u,0,0,u),"x z":new r(0,0,-u,u),"-x z":new r(0,0,u,u)};class BasicRotationTransformer{transformMove(t){}transformOrientation(t){const{x:e,y:i,z:a,w:o}=t.quaternion,s=new r(e,i,a,o),u=new n(0,1,0),h=new n(0,0,1),d=c(u.applyQuaternion(s)),f=c(h.applyQuaternion(s)),v=l[`${d} ${f}`]||l["y z"];console.log(s),console.log(v);const y=s.premultiply(v);console.log(y),t.quaternion={x:y.x,y:y.y,z:y.z,w:y.w},console.log(t.quaternion)}}class BluetoothPuzzle{constructor(){this.transformers=[],this.listeners=[],this.orientationListeners=[]}getState(){return s(this,void 0,void 0,(function*(){throw new Error("cannot get state")}))}addMoveListener(t){this.listeners.push(t)}addOrientationListener(t){this.orientationListeners.push(t)}experimentalAddBasicRotationTransformer(){this.transformers.push(new BasicRotationTransformer)}dispatchMove(t){for(const e of this.transformers)e.transformMove(t);for(const e of this.listeners)e(t)}dispatchOrientation(t){for(const e of this.transformers)e.transformOrientation(t);for(const e of this.orientationListeners)e(t)}}let h=!0;function d(t){h=t}function f(...t){h&&(console.info?console.info.apply(console,t):console.log.apply(console,t))}const v=new Uint8Array(16),y=new Uint8Array(new Array(16).fill(16));function p(t,e){return s(this,void 0,void 0,(function*(){const i=yield function(t,e,i){return s(this,void 0,void 0,(function*(){return(yield window.crypto.subtle.encrypt({name:"AES-CBC",iv:i},t,e)).slice(0,16)}))}(t,y,e),r=new Uint8Array(32);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(i),16),(yield window.crypto.subtle.decrypt({name:"AES-CBC",iv:v},t,r)).slice(0,16)}))}const m={0:t("U"),2:t("U",-1),3:t("R"),5:t("R",-1),6:t("F"),8:t("F",-1),9:t("D"),11:t("D",-1),12:t("L"),14:t("L",-1),15:t("B"),17:t("B",-1)};let w=null;function b(t){return t[13]<18&&t[14]<18&&t[15]<18&&t[16]<18&&t[17]<18&&t[18]<18}const C=new Uint8Array([198,202,21,223,79,110,19,182,119,13,230,89,58,175,186,162]);new Uint8Array([67,226,91,214,125,220,120,216,7,96,163,218,130,60,1,241]);function g(t,e,i){return s(this,void 0,void 0,(function*(){const e=new Uint8Array(C);for(let t=0;t<i.length;t++)e[t]=(e[t]+i[t])%256;const r=yield function(t){return s(this,void 0,void 0,(function*(){return yield crypto.subtle.importKey("raw",t,"AES-CBC",!0,["encrypt","decrypt"])}))}(new Uint8Array(e));return t.set(new Uint8Array(yield p(r,t.slice(3))),3),t.set(new Uint8Array(yield p(r,t.slice(0,16))),0),t}))}function A(t,e){return s(this,void 0,void 0,(function*(){if(b(t))return t;const i=yield g(t,0,e);if(b(i))return i;const r=yield g(t,0,e);if(b(r))return r;throw new Error("Unable to decode")}))}class PhysicalState{constructor(t,e){if(this.dataView=t,this.timeStamp=e,this.arrLen=19,this.arr=new Uint8Array(t.buffer),this.arr.length!==this.arrLen)throw new Error("Unexpected array length")}static read(t,e){return s(this,void 0,void 0,(function*(){const i=yield A(new Uint8Array((yield t.readValue()).buffer),e),r=Date.now();return new PhysicalState(new DataView(i.buffer),r)}))}rotQuat(){let t=this.dataView.getInt16(0,!0)/16384,e=this.dataView.getInt16(2,!0)/16384,i=this.dataView.getInt16(4,!0)/16384;[t,e,i]=[-e,i,-t];const n=1-(t*t+e*e+i*i),a=n>0?Math.sqrt(n):0,o=new r(t,e,i,a);return w||(w=o.clone().inverse()),o.clone().multiply(w.clone())}moveCounter(){return this.arr[12]}numMovesSince(t){return this.moveCounter()-t&255}latestMoves(t){if(t<0||t>6)throw new Error(`Must ask for 0 to 6 latest moves. (Asked for ${t})`);return Array.from(this.arr.slice(19-t,19)).map(t=>m[t])}debugInfo(){return{arr:this.arr}}}const S="0000fff0-0000-1000-8000-00805f9b34fb",z="0000fff5-0000-1000-8000-00805f9b34fb",E="0000fff7-0000-1000-8000-00805f9b34fb",R="0000fff2-0000-1000-8000-00805f9b34fb",U="0000fff3-0000-1000-8000-00805f9b34fb",B={reset:new Uint8Array([0,0,36,0,73,146,36,73,109,146,219,182,73,146,182,36,109,219])},M={filters:[{namePrefix:"GAN"}],optionalServices:[S]};const x="UF UR UB UL DF DR DB DL FR FL BR BL".split(" "),D="UFR URB UBL ULF DRF DFL DLB DBR".split(" ");function G(t,e){return t.slice(e)+t.slice(0,e)}const L={};x.forEach((t,e)=>{for(let i=0;i<2;i++)L[G(t,i)]={piece:e,orientation:i}}),D.forEach((t,e)=>{for(let i=0;i<3;i++)L[G(t,i)]={piece:e,orientation:i}});const P=[[0,21,15],[5,13,47],[7,45,39],[2,37,23],[29,10,16],[31,18,32],[26,34,40],[24,42,8]],F=[[1,22],[3,14],[6,46],[4,38],[30,17],[27,9],[25,41],[28,33],[19,12],[20,35],[44,11],[43,36]];class GanCube extends BluetoothPuzzle{constructor(t,e,i,r,n){super(),this.service=t,this.server=e,this.physicalStateCharacteristic=i,this.lastMoveCounter=r,this.macAddress=n,this.INTERVAL_MS=150,this.intervalHandle=null,this.kpuzzle=new a(o["3x3x3"]),this.startTrackingMoves()}static connect(t){return s(this,void 0,void 0,(function*(){const e=function(t){const e=new Uint8Array([76,36,152,0,0,0]);return 10===t.length&&t.startsWith("GAN-")||console.warn("Unexpected puzzle name."),e[3]=parseInt(t.slice(4,6),16),e[4]=parseInt(t.slice(6,8),16),e[5]=parseInt(t.slice(8,10),16),e}(t.device.name),i=yield t.getPrimaryService(S);f("Service:",i);const r=yield i.getCharacteristic(z);f("Characteristic:",r);const n=(yield PhysicalState.read(r,e)).moveCounter();return f("Initial Move Counter:",n),new GanCube(i,t,r,n,e)}))}name(){return this.server.device.name}startTrackingMoves(){this.intervalHandle=window.setInterval(this.intervalHandler.bind(this),this.INTERVAL_MS)}stopTrackingMoves(){if(!this.intervalHandle)throw new Error("Not tracking moves!");clearInterval(this.intervalHandle),this.intervalHandle=null}intervalHandler(){return s(this,void 0,void 0,(function*(){const t=yield PhysicalState.read(this.physicalStateCharacteristic,this.macAddress);let e=t.numMovesSince(this.lastMoveCounter);e>6&&(f(`Too many moves! Dropping ${e-6} moves`),e=6);for(const i of t.latestMoves(e))this.kpuzzle.applyBlockMove(i),this.dispatchMove({latestMove:i,timeStamp:t.timeStamp,debug:t.debugInfo(),state:this.kpuzzle.state});const{x:i,y:r,z:n,w:a}=t.rotQuat();this.dispatchOrientation({timeStamp:t.timeStamp,quaternion:{x:i,y:r,z:n,w:a}}),this.lastMoveCounter=t.moveCounter()}))}getBattery(){return s(this,void 0,void 0,(function*(){return new Uint8Array(yield this.readActualAngleAndBatteryCharacteristic())[7]}))}getState(){return s(this,void 0,void 0,(function*(){const t=yield A(new Uint8Array(yield this.readFaceletStatus1Characteristic()),this.macAddress),e=[];for(let i=0;i<18;i+=3){let r=((t[1^i]<<8)+t[i+1^1]<<8)+t[i+2^1];for(let t=0;t<8;t++)e.push(7&r),r>>=3}const i={CORNER:{permutation:[],orientation:[]},EDGE:{permutation:[],orientation:[]},CENTER:{permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]}};for(const t of P){const r=L[t.map(t=>"URFDLB"[e[t]]).join("")];i.CORNER.permutation.push(r.piece),i.CORNER.orientation.push(r.orientation)}for(const t of F){const r=L[t.map(t=>"URFDLB"[e[t]]).join("")];i.EDGE.permutation.push(r.piece),i.EDGE.orientation.push(r.orientation)}return i}))}faceletStatus1Characteristic(){return s(this,void 0,void 0,(function*(){return this.cachedFaceletStatus1Characteristic=this.cachedFaceletStatus1Characteristic||this.service.getCharacteristic(R),this.cachedFaceletStatus1Characteristic}))}faceletStatus2Characteristic(){return s(this,void 0,void 0,(function*(){return this.cachedFaceletStatus2Characteristic=this.cachedFaceletStatus2Characteristic||this.service.getCharacteristic(U),this.cachedFaceletStatus2Characteristic}))}actualAngleAndBatteryCharacteristic(){return s(this,void 0,void 0,(function*(){return this.cachedActualAngleAndBatteryCharacteristic=this.cachedActualAngleAndBatteryCharacteristic||this.service.getCharacteristic(E),this.cachedActualAngleAndBatteryCharacteristic}))}reset(){return s(this,void 0,void 0,(function*(){const t=yield this.faceletStatus1Characteristic();yield t.writeValue(B.reset)}))}readFaceletStatus1Characteristic(){return s(this,void 0,void 0,(function*(){const t=yield this.faceletStatus1Characteristic();return(yield t.readValue()).buffer}))}readFaceletStatus2Characteristic(){return s(this,void 0,void 0,(function*(){const t=yield this.faceletStatus2Characteristic();return e=(yield t.readValue()).buffer,Array.prototype.map.call(new Uint8Array(e),t=>("00"+t.toString(16)).slice(-2)).join(" ");var e}))}readActualAngleAndBatteryCharacteristic(){return s(this,void 0,void 0,(function*(){const t=yield this.actualAngleAndBatteryCharacteristic();return(yield t.readValue()).buffer}))}}const K="0000aadb-0000-1000-8000-00805f9b34fb",I="0000aadc-0000-1000-8000-00805f9b34fb",T={filters:[{namePrefix:"Gi"},{services:["0000aadb-0000-1000-8000-00805f9b34fb"]},{services:["0000aaaa-0000-1000-8000-00805f9b34fb"]},{services:["0000fe95-0000-1000-8000-00805f9b34fb"]}],optionalServices:[K]};function V(e,i){return 9===i&&(f("Encountered 9",e,i),i=2),t(["?","B","D","L","U","R","F"][e],i=[0,1,2,-1][i])}const O={permutation:[0,1,2,3,4,5],orientation:[0,0,0,0,0,0]},N=[4,8,0,9,5,1,3,7,6,10,2,11],Q=[2,5,10,6,0,4,8,7,1,3,9,11],k=[1,0,1,0,1,0,1,0,0,0,0,0],j=[1,0,1,0,1,0,1,0,0,0,0,0],q=[4,0,3,5,7,1,2,6],H=[1,5,6,2,0,3,7,4],_=[1,2,1,2,2,1,2,1],$=[2,1,2,1,1,2,1,2],W=[-1,1,-1,1,1,-1,1,-1];function J(t,e){return e%2==1?t[e/2|0]%16:0|t[e/2|0]/16}const X=[176,81,104,224,86,137,237,119,38,26,193,161,210,126,150,81,93,13,236,249,89,235,88,24,113,81,214,131,130,199,2,169,39,165,171,41];function Y(t){return s(this,void 0,void 0,(function*(){return function(t){return 167===t[18]}(t)?yield function(t){const e=J(t,38),i=J(t,39),r=new Uint8Array(20);for(let n=0;n<20;n++)r[n]=t[n]+X[e+n]+X[i+n];return r}(t):t}))}class GiiKERCube extends BluetoothPuzzle{constructor(t,e,i){super(),this.server=t,this.cubeCharacteristic=e,this.originalValue=i}static connect(t){return s(this,void 0,void 0,(function*(){const e=yield t.getPrimaryService(K);f("Service:",e);const i=yield e.getCharacteristic(I);f("Characteristic:",i);const r=yield Y(new Uint8Array((yield i.readValue()).buffer));f("Original value:",r);const n=new GiiKERCube(t,i,r);return yield i.startNotifications(),i.addEventListener("characteristicvaluechanged",n.onCubeCharacteristicChanged.bind(n)),n}))}name(){return this.server.device.name}getState(){return s(this,void 0,void 0,(function*(){return this.toReid333(new Uint8Array((yield this.cubeCharacteristic.readValue()).buffer))}))}getBit(t,e){const i=7-e%8;return t[e/8|0]>>i&1}toReid333(t){const e={EDGE:{permutation:new Array(12),orientation:new Array(12)},CORNER:{permutation:new Array(8),orientation:new Array(8)},CENTER:O};for(let i=0;i<12;i++){const r=Q[i];e.EDGE.permutation[i]=N[J(t,r+16)-1],e.EDGE.orientation[i]=this.getBit(t,r+112)^k[e.EDGE.permutation[i]]^j[i]}for(let i=0;i<8;i++){const r=H[i];e.CORNER.permutation[i]=q[J(t,r)-1],e.CORNER.orientation[i]=(J(t,r+8)*W[r]+_[e.CORNER.permutation[i]]+$[i])%3}return e}onCubeCharacteristicChanged(t){return s(this,void 0,void 0,(function*(){const e=yield Y(new Uint8Array(t.target.value.buffer));if(f(e),f(e),this.isRepeatedInitialValue(e))return void f("Skipping repeated initial value.");const i=[];for(let t=0;t<20;t++)i.push(Math.floor(e[t]/16)),i.push(e[t]%16);f(i);const r=function(t){let e="";return e+=t.slice(0,8).join("."),e+="\n",e+=t.slice(8,16).join("."),e+="\n",e+=t.slice(16,28).join("."),e+="\n",e+=t.slice(28,32).join("."),e+="\n",e+=t.slice(32,40).join("."),e}(i);f(r),this.dispatchMove({latestMove:V(i[32],i[33]),timeStamp:t.timeStamp,debug:{stateStr:r},state:this.toReid333(e)})}))}isRepeatedInitialValue(t){if(void 0===this.originalValue)throw new Error("GiiKERCube has uninitialized original value.");if(null===this.originalValue)return!1;const e=this.originalValue;this.originalValue=null,f("Comparing against original value.");for(let i=0;i<18;i++)if(e[i]!==t[i])return f("Different at index ",i),!1;return!0}}const Z="6e400001-b5a3-f393-e0a9-e50e24dcca9e",tt="6e400003-b5a3-f393-e0a9-e50e24dcca9e",et={filters:[{namePrefix:"GoCube"}],optionalServices:[Z]};function it(t){return Array.prototype.map.call(new Uint8Array(t),t=>("00"+t.toString(16)).slice(-2)).join("")}const rt=[t("B",1),t("B",-1),t("F",1),t("F",-1),t("U",1),t("U",-1),t("D",1),t("D",-1),t("R",1),t("R",-1),t("L",1),t("L",-1)];class GoCube extends BluetoothPuzzle{constructor(t,i){super(),this.server=t,this.goCubeStateCharacteristic=i,this.recorded=[],this.homeQuatInverse=null,this.lastRawQuat=new r(0,0,0,1),this.currentQuat=new r(0,0,0,1),this.lastTarget=new r(0,0,0,1),this.alg=new e([])}static connect(t){return s(this,void 0,void 0,(function*(){const e=yield t.getPrimaryService(Z);f({service:e});const i=yield e.getCharacteristic(tt);f({goCubeStateCharacteristic:i});const r=new GoCube(t,i);return yield i.startNotifications(),i.addEventListener("characteristicvaluechanged",r.onCubeCharacteristicChanged.bind(r)),r}))}reset(){this.resetAlg(),this.resetOrientation()}resetAlg(t){this.alg=t||new e([])}resetOrientation(){this.homeQuatInverse=this.lastRawQuat.clone().inverse(),this.currentQuat=new r(0,0,0,1),this.lastTarget=new r(0,0,0,1)}name(){return this.server.device.name}onCubeCharacteristicChanged(t){const i=t.target.value;if(this.recorded.push([t.timeStamp,it(i.buffer)]),8===i.byteLength){const r=rt[i.getUint8(3)];this.alg=new e(this.alg.nestedUnits.concat([r])),this.dispatchMove({latestMove:rt[i.getUint8(3)],timeStamp:t.timeStamp,debug:{stateStr:it(i.buffer)}})}else{const e=function(t){const e=new Uint8Array(t);let i="";for(const t of e)i+=String.fromCharCode(t);return i}(i.buffer.slice(3,i.byteLength-3)).split("#").map(t=>parseInt(t,10)/16384),n=new r(e[0],e[1],e[2],e[3]);this.lastRawQuat=n.clone(),this.homeQuatInverse||(this.homeQuatInverse=n.clone().inverse());const a=n.clone().multiply(this.homeQuatInverse.clone());a.y=-a.y,this.lastTarget.slerp(a,.5),this.currentQuat.rotateTowards(this.lastTarget,nt);const{x:o,y:s,z:c,w:u}=this.currentQuat;this.dispatchOrientation({quaternion:{x:o,y:s,z:c,w:u},timeStamp:t.timeStamp})}}}const nt=.5;let at=0;function ot(t={}){return s(this,void 0,void 0,(function*(){let e;f("Attempting to pair.");try{let i=t.acceptAllDevices;!i&&at>=2&&(console.info("The last 2 Bluetooth puzzle connection attempts failed. This time, the Bluetooth prompt will show all possible devices."),i=!0),e=yield navigator.bluetooth.requestDevice(function(t=!1){const e=t?{acceptAllDevices:!0,optionalServices:[]}:{filters:[],optionalServices:[]};for(const i of[M,T,et])t||(e.filters=e.filters.concat(i.filters)),e.optionalServices=e.optionalServices.concat(i.optionalServices);return f({requestOptions:e}),e}(i)),at=0}catch(t){throw at++,new Error(t)}if(f("Device:",e),void 0===e.gatt)return Promise.reject("Device did not have a GATT server.");const i=yield e.gatt.connect();f("Server:",i);const r=i.device.name||"";return r&&r.startsWith("GAN")?yield GanCube.connect(i):r&&r.startsWith("GoCube")?yield GoCube.connect(i):yield GiiKERCube.connect(i)}))}const st=o["3x3x3"];class KeyboardPuzzle extends BluetoothPuzzle{constructor(t){super(),this.puzzle=new a(st),t.addEventListener("keydown",this.onKeyDown.bind(this))}name(){return"Keyboard Input"}getState(){return s(this,void 0,void 0,(function*(){return this.puzzle.state}))}onKeyDown(t){if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return;const e=i(t);e&&(this.puzzle.applyBlockMove(e),this.dispatchMove({latestMove:e,timeStamp:t.timeStamp,state:this.puzzle.state}),t.preventDefault())}}function ct(t=window){return s(this,void 0,void 0,(function*(){return new KeyboardPuzzle(t)}))}var ut=Object.freeze({__proto__:null,BluetoothPuzzle:BluetoothPuzzle,connect:ot,enableDebugLogging:d,GanCube:GanCube,GiiKERCube:GiiKERCube,giikerMoveToBlockMoveForTesting:V,GoCube:GoCube,debugKeyboardConnect:ct,KeyboardPuzzle:KeyboardPuzzle});export{BluetoothPuzzle as B,GanCube as G,KeyboardPuzzle as K,GiiKERCube as a,GoCube as b,ot as c,ct as d,d as e,V as g,ut as i};
//# sourceMappingURL=index-4efc51af.js.map
